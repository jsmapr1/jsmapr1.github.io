
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>testing apis with nock  | Dev</title>

<meta name="author" content="Joe"> 

<meta name="description" content="I recently wrote about how to use json-server to mock api calls when writing web apps.
And that is very useful when you want write code and not have &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Dev" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">Dev</a></h1>
<h4>The Art of Working With Code(rs)</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:www.thejoemorgan.com">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">Testing Apis With Nock</h2>
	<div class="entry-content"><p>I <a href="/blog/2016/04/07/mocking-apis-locally-with-webpack-dot-environmentplugin-and-json-server/">recently wrote</a> about how to use json-server to mock api calls when writing web apps.
And that is very useful when you want write code and not have to worry about latency or api limits.
However, it is still an extra dependency and may not make sense in all projects.</p>

<p>Testing needs to be self contained and have minimal external dependencies (for now, I will just talk about unit testing).
In addition, I want to be able to test things that may have a security component that I do not want publicly exposed (an api key, for example).
Allowing mocking in tests prevents them from exposing secure information while still ensuring that all the code is tested (that&rsquo;s the goal at least).
For this reason, I have taken a liking to <a href="https://github.com/node-nock/nock">nock</a> for mocking out expected api calls.
I&rsquo;ve recently been using it heavily as I build an <a href="https://github.com/jsmapr1/frontend-gitlab/">api wrapper library</a> and I become more impressed with the project each time I use it.</p>

<h2>Basic Example</h2>

<p>What makes nock so great is its simplicity.</p>

<p>Here&rsquo;s a very basic example using mocha:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="nx">expect</span> <span class="nx">from</span> <span class="s1">&#39;expect&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">nock</span> <span class="nx">from</span> <span class="s1">&#39;nock&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;fetch test&#39;</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">before</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">nock</span><span class="p">(</span><span class="s1">&#39;http://foo.com&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/events&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="nx">events</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">after</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">nock</span><span class="p">.</span><span class="nx">cleanAll</span><span class="p">()</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should get events&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://foo.com/api/events&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>
</span><span class='line'>            <span class="p">})</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">json</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">expect</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">events</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">])</span>
</span><span class='line'>            <span class="p">})</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>As with most examples, this is very contrived; it doesn&rsquo;t seem like I&rsquo;m testing much.
Still, it shows the beauty and simplicity of nock.</p>

<p>To break it down:</p>

<ol>
<li><p>We set a url to capture</p></li>
<li><p>We set a REST request on a particular path</p></li>
<li><p>We give a return value</p></li>
</ol>


<p>Each piece is small and clearly defined and allows nice chaining.</p>

<p>The power of nock is that the chaining allows us to add additional elements to our test.</p>

<p>Here&rsquo;s a slightly more complicated example from a <a href="https://github.com/jsmapr1/frontend-gitlab/blob/a704f8f5fc2bc6165811ba31da8fbe401c37fd25/test/requests/issues--test.js">gitlab wrapper package</a> I&rsquo;m writing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="nx">expect</span> <span class="nx">from</span> <span class="s1">&#39;expect&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">nock</span> <span class="nx">from</span> <span class="s1">&#39;nock&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">fetch</span> <span class="nx">from</span> <span class="s1">&#39;isomorphic-fetch&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">getIssues</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../../src/requests/Issues&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;issues&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">issue</span> <span class="o">=</span>  <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;iid&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;project_id&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;state&quot;</span><span class="o">:</span> <span class="s2">&quot;opened&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;created_at&quot;</span><span class="o">:</span> <span class="s2">&quot;2016-05-12T08:16:27.337-05:00&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;updated_at&quot;</span><span class="o">:</span> <span class="s2">&quot;2016-05-12T08:16:27.337-05:00&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;labels&quot;</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>    <span class="s2">&quot;milestone&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;assignee&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;username&quot;</span><span class="o">:</span> <span class="s2">&quot;var&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;state&quot;</span><span class="o">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;avatar_url&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;web_url&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s2">&quot;subscribed&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">before</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">nock</span><span class="p">(</span><span class="s1">&#39;http://foo.gitlab.com/api/v3&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">reqheaders</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;PRIVATE-TOKEN&#39;</span><span class="o">:</span> <span class="s1">&#39;abc123&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">persist</span><span class="p">()</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/issues&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">[</span><span class="nx">issue</span><span class="p">])</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">after</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">nock</span><span class="p">.</span><span class="nx">cleanAll</span><span class="p">()</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;will return issues&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">getIssues</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span><span class="s1">&#39;http://foo.gitlab.com&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="o">:</span><span class="s1">&#39;abc123&#39;</span><span class="p">})().</span><span class="nx">then</span><span class="p">(</span><span class="nx">json</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">expect</span><span class="p">(</span><span class="nx">json</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">([</span><span class="nx">issue</span><span class="p">])</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;can take authentication separate&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">issues</span> <span class="o">=</span> <span class="nx">getIssues</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span><span class="s1">&#39;http://foo.gitlab.com&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="o">:</span><span class="s1">&#39;abc123&#39;</span><span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">issues</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">json</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">expect</span><span class="p">(</span><span class="nx">json</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">([</span><span class="nx">issue</span><span class="p">])</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is nearly identical to the first examples with a few differences:</p>

<ol>
<li>I&rsquo;m adding in some request headers. This will ensure that the function I&rsquo;m calling is passed a PRIVATE-TOKEN.</li>
<li>I&rsquo;m calling an additional method <code>persist()</code>. This ensures that the same mock will be avaialable for subsequent tests.
In this case, I want to test a curried and an uncurried version. This allows the same mock to be used for both.</li>
</ol>


<p>The beauty part is that it still retains the simplicity of the first example.
It&rsquo;s short, readable, and most importantly, it just works.</p>

<p>I&rsquo;m just starting to scratch the surface, so be on the lookout for more as I go forward.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-05-18T09:27:41-05:00" pubdate data-updated="true"></time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/testing/'>testing</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2017

    Joe

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-84697313-1');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



</body>
</html>
