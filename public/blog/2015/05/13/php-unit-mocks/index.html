
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>PHP Unit Mocks  | Dev</title>

<meta name="author" content="Joe"> 

<meta name="description" content="I recently had to do some development with a third party api.
We&rsquo;ve worked with several apis in the past and they&rsquo;ve always been a huge &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Dev" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">Dev</a></h1>
<h4>The Art of Working With Code(rs)</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:www.thejoemorgan.com">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">PHP Unit Mocks</h2>
	<div class="entry-content"><p>I recently had to do some development with a third party api.
We&rsquo;ve worked with several apis in the past and they&rsquo;ve always been a huge hassle and, more importantly, we&rsquo;ve never bothered to test code so we can isolate problems should there be a change by the api provider (we are always the last to be notified).</p>

<h2>PHP Unit Mocks</h2>

<p>The best way to test an api is to set up a mock so we can test our api code against the expected return value (the json or xml or whatever).
Fortunately, PHP Unit <a href="https://phpunit.de/manual/current/en/test-doubles.html">has built in mocks</a>.</p>

<p>Working with other apis, we&rsquo;ve abstracted method calls behind a common interface.
In other words, we want to be able to say <code>$api-&gt;getData();</code> and not have to worry about which api we are using or which methods the api is calling.
We just want the data back in a clear, standard way.</p>

<p>Essentially, it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$provider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SomeThirdParty</span><span class="p">(</span><span class="nv">$configs</span><span class="p">);</span>
</span><span class='line'><span class="nv">$widgets</span> <span class="o">=</span> <span class="nv">$provider</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">();</span>
</span><span class='line'><span class="c1">//array of standard group of Widget objects built from the data of any api</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the test, we want to do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">class</span> <span class="nc">SomeProviderTest</span> <span class="k">extends</span> <span class="nx">PHPUnit_Framework_TestCase</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetData</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$provider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SomeThirdParty</span><span class="p">();</span>
</span><span class='line'>        <span class="c1">//getData calls fetchData internally</span>
</span><span class='line'>        <span class="nv">$widgets</span> <span class="o">=</span> <span class="nv">$provider</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$widget</span> <span class="o">=</span> <span class="nb">reset</span><span class="p">(</span><span class="nv">$widget</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nv">$widget</span><span class="o">-&gt;</span><span class="na">price</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s some example code (assume a Soap client):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">class</span> <span class="nc">SomeThirdPary</span> <span class="k">extends</span> <span class="nx">ApiBase</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//Something something connect to api.</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">fetchData</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SoapClient</span><span class="p">(</span><span class="s2">&quot;https://coolapp.com&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;soap_version&#39;</span> <span class="o">=&gt;</span> <span class="nx">SOAP_1_2</span><span class="p">,));</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">getWidgets</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>            <span class="s1">&#39;user&#39;</span>      <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span>
</span><span class='line'>            <span class="s1">&#39;apiKey&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nx">SimpleXMLElement</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">getData</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$widgets</span> <span class="o">=</span>  <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$allWidgets</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fetchData</span><span class="p">();</span>
</span><span class='line'>        <span class="k">foreach</span><span class="p">(</span><span class="nv">$allWidgets</span> <span class="k">as</span> <span class="nv">$widget</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$w</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Widget</span><span class="p">(</span><span class="nv">$widget</span><span class="p">)</span>
</span><span class='line'>            <span class="c1">//Probablly do some more stuff</span>
</span><span class='line'>            <span class="nv">$widgets</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$w</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$widgets</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The challenge is to mock the response which, in this case, will be an XML element.
Remember, we want to be as close to reality as possible without actually making a live api call.</p>

<p>In the above example, we need to mock out the fetchData method or else a the code will actually try and connect to the api.
And if that happens, beyond being ineffiencent, we won&rsquo;t be able to predict the return results.</p>

<p>Mocks to the rescue!</p>

<p>With mocks, we can set which methods we know will be called and then stipulate a return value.
We don&rsquo;t want to mock all methods; doing so would keep the code from being executed thus rendering the test useless.
The only important method is the api method.</p>

<p>The syntax is pretty straightforward:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'>        <span class="nv">$mock</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMockBuilder</span><span class="p">(</span><span class="s1">&#39;MockedClass&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//We only want to mock the fetchData method. Because we want getData to execute</span>
</span><span class='line'>        <span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;fetchData&#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//Set the return</span>
</span><span class='line'>        <span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
</span><span class='line'>             <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
</span><span class='line'>              <span class="o">-&gt;</span><span class="na">will</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">returnValue</span><span class="p">(</span><span class="k">new</span> <span class="nx">\SimpleXMLElement</span><span class="p">(</span><span class="nv">$widgetXML</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alright, let&rsquo;s try it with the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">class</span> <span class="nc">SomeProviderTest</span> <span class="k">extends</span> <span class="nx">PHPUnit_Framework_TestCase</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetData</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$provider</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMockBuilder</span><span class="p">(</span><span class="s1">&#39;SomeThirdParty&#39;</span><span class="p">)</span>
</span><span class='line'>                     <span class="o">-&gt;</span><span class="na">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;fetchData&#39;</span><span class="p">))</span>
</span><span class='line'>                     <span class="o">-&gt;</span><span class="na">getMock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$widgetXML</span> <span class="o">=</span> <span class="o">&lt;&lt;&lt;</span><span class="nx">EOT</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">Widget</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">Widget</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Id</span><span class="o">&gt;</span><span class="mi">54</span><span class="o">&lt;/</span><span class="nx">Id</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Price</span><span class="o">&gt;</span><span class="mf">34.00</span><span class="o">&lt;/</span><span class="nx">Price</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Length</span><span class="o">&gt;</span><span class="mf">5.00</span><span class="o">&lt;/</span><span class="nx">Length</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Width</span><span class="o">&gt;</span><span class="mf">5.00</span><span class="o">&lt;/</span><span class="nx">Width</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;/</span><span class="nx">Widget</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">Widget</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Id</span><span class="o">&gt;</span><span class="mi">87</span><span class="o">&lt;/</span><span class="nx">Id</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Price</span><span class="o">&gt;</span><span class="mf">42.00</span><span class="o">&lt;/</span><span class="nx">Price</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Length</span><span class="o">&gt;</span><span class="mf">10.00</span><span class="o">&lt;/</span><span class="nx">Length</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Width</span><span class="o">&gt;</span><span class="mf">5.00</span><span class="o">&lt;/</span><span class="nx">Width</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;/</span><span class="nx">Widget</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;/</span><span class="nx">Widgets</span><span class="o">&gt;</span>
</span><span class='line'><span class="nx">EOT</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$provider</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
</span><span class='line'>             <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;fetchData&#39;</span><span class="p">)</span>
</span><span class='line'>              <span class="o">-&gt;</span><span class="na">will</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">returnValue</span><span class="p">(</span><span class="k">new</span> <span class="nx">\SimpleXMLElement</span><span class="p">(</span><span class="nv">$widgetXML</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//getData calls fetchData internally. We never need to call it.</span>
</span><span class='line'>        <span class="nv">$widgets</span> <span class="o">=</span> <span class="nv">$provider</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$widget</span> <span class="o">=</span> <span class="nb">reset</span><span class="p">(</span><span class="nv">$widget</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//For now, we&#39;ll just check price. Probably need ot check other things.</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mf">34.00</span><span class="p">,</span> <span class="nv">$widget</span><span class="o">-&gt;</span><span class="na">price</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That all there is to it. Now this test will make sure that getData is accurately calling a method, pulling in the data, and performing whatever needs to be done to get the data usable.
In the future if we need change the getData method (maybe get an inventory count for each widget), this test will ensure that a the api will still be called and a price set.
In addition, if getData eventually needs to make more api calls &ndash; for example, maybe it pulls discounts with another method &ndash; we can add those and mock them out in the same way.
Regardless, the test now closely matches the reality the code will experience which will give future developers the security they need to make changes and update code.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-05-13T16:32:53-05:00" pubdate data-updated="true"></time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/php/'>php</a>, <a class='category' href='/blog/categories/testing/'>testing</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2017

    Joe

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-84697313-1');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



</body>
</html>
